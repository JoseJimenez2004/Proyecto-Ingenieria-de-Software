<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Login Enfermero</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .test-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .btn-test {
            margin: 5px;
        }
        .result {
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-success {
            background-color: #28a745;
            color: white;
        }
        .status-error {
            background-color: #dc3545;
            color: white;
        }
        .status-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .credentials-test {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            font-family: monospace;
        }
        .login-simulation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">üß™ Test - Login Enfermero</h1>
        <p class="text-center mb-4">Pruebas para la funcionalidad de autenticaci√≥n del personal de enfermer√≠a</p>
        
        <!-- Secci√≥n 1: Pruebas de Autenticaci√≥n -->
        <div class="test-section">
            <h2 class="test-title">üîê Pruebas de Autenticaci√≥n</h2>
            
            <div class="test-grid">
                <div class="test-card">
                    <h5>1. Login V√°lido</h5>
                    <p>Prueba el login con credenciales correctas</p>
                    <button class="btn btn-primary btn-test" onclick="testLoginValido()">Ejecutar Prueba</button>
                    <div id="result1" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>2. Login con Email Incorrecto</h5>
                    <p>Prueba el login con email inexistente</p>
                    <button class="btn btn-warning btn-test" onclick="testLoginEmailIncorrecto()">Ejecutar Prueba</button>
                    <div id="result2" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>3. Login con Contrase√±a Incorrecta</h5>
                    <p>Prueba el login con contrase√±a err√≥nea</p>
                    <button class="btn btn-warning btn-test" onclick="testLoginPasswordIncorrecto()">Ejecutar Prueba</button>
                    <div id="result3" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>4. Login sin Credenciales</h5>
                    <p>Prueba el login sin ingresar datos</p>
                    <button class="btn btn-warning btn-test" onclick="testLoginSinCredenciales()">Ejecutar Prueba</button>
                    <div id="result4" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>5. Login con Email Inv√°lido</h5>
                    <p>Prueba el login con formato de email incorrecto</p>
                    <button class="btn btn-warning btn-test" onclick="testLoginEmailInvalido()">Ejecutar Prueba</button>
                    <div id="result5" class="result"></div>
                </div>
            </div>
        </div>
        
        <!-- Secci√≥n 2: Pruebas de Formulario -->
        <div class="test-section">
            <h2 class="test-title">üìù Pruebas de Formulario</h2>
            
            <div class="test-grid">
                <div class="test-card">
                    <h5>6. Validaci√≥n de Campos</h5>
                    <p>Prueba la validaci√≥n de campos requeridos</p>
                    <button class="btn btn-primary btn-test" onclick="testValidacionCampos()">Ejecutar Prueba</button>
                    <div id="result6" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>7. Mostrar/Ocultar Contrase√±a</h5>
                    <p>Prueba la funcionalidad de mostrar contrase√±a</p>
                    <button class="btn btn-info btn-test" onclick="testTogglePassword()">Ejecutar Prueba</button>
                    <div id="result7" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>8. Limpiar Formulario</h5>
                    <p>Prueba la funcionalidad de limpiar el formulario</p>
                    <button class="btn btn-secondary btn-test" onclick="testLimpiarFormulario()">Ejecutar Prueba</button>
                    <div id="result8" class="result"></div>
                </div>
            </div>
        </div>
        
        <!-- Secci√≥n 3: Pruebas de Seguridad -->
        <div class="test-section">
            <h2 class="test-title">üõ°Ô∏è Pruebas de Seguridad</h2>
            
            <div class="test-grid">
                <div class="test-card">
                    <h5>9. Token de Autenticaci√≥n</h5>
                    <p>Prueba la generaci√≥n y validaci√≥n de tokens</p>
                    <button class="btn btn-primary btn-test" onclick="testTokenAutenticacion()">Ejecutar Prueba</button>
                    <div id="result9" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>10. Expiraci√≥n de Sesi√≥n</h5>
                    <p>Prueba el manejo de sesiones expiradas</p>
                    <button class="btn btn-warning btn-test" onclick="testExpiracionSesion()">Ejecutar Prueba</button>
                    <div id="result10" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>11. Intentos Fallidos</h5>
                    <p>Prueba el bloqueo por m√∫ltiples intentos fallidos</p>
                    <button class="btn btn-warning btn-test" onclick="testIntentosFallidos()">Ejecutar Prueba</button>
                    <div id="result11" class="result"></div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 4: Pruebas de Integraci√≥n -->
        <div class="test-section">
            <h2 class="test-title">üîÑ Pruebas de Integraci√≥n</h2>
            
            <div class="test-grid">
                <div class="test-card">
                    <h5>12. Redirecci√≥n Post-Login</h5>
                    <p>Prueba la redirecci√≥n despu√©s del login exitoso</p>
                    <button class="btn btn-success btn-test" onclick="testRedireccionPostLogin()">Ejecutar Prueba</button>
                    <div id="result12" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>13. Diferentes Roles de Usuario</h5>
                    <p>Prueba login con diferentes tipos de usuario</p>
                    <button class="btn btn-primary btn-test" onclick="testDiferentesRoles()">Ejecutar Prueba</button>
                    <div id="result13" class="result"></div>
                </div>
                
                <div class="test-card">
                    <h5>14. Flujo Completo</h5>
                    <p>Prueba el flujo completo de autenticaci√≥n</p>
                    <button class="btn btn-success btn-test" onclick="testFlujoCompleto()">Ejecutar Prueba</button>
                    <div id="result14" class="result"></div>
                </div>
            </div>
        </div>
        
        <!-- Bot√≥n para ejecutar todas las pruebas -->
        <div class="text-center mt-4">
            <button class="btn btn-lg btn-primary" onclick="ejecutarTodasLasPruebas()">üöÄ Ejecutar Todas las Pruebas</button>
            <div id="resultGeneral" class="result mt-3"></div>
        </div>
    </div>

    <script>
        // Variables para almacenar resultados
        let resultadosPruebas = [];
        let tokenSesion = null;

        // Funci√≥n para mostrar resultados
        function mostrarResultado(elementId, mensaje, tipo) {
            const elemento = document.getElementById(elementId);
            elemento.innerHTML = mensaje;
            elemento.className = 'result ' + tipo;
            elemento.style.display = 'block';
        }

        // 1. Prueba: Login V√°lido
        async function testLoginValido() {
            const datos = {
                email: "maria.garcia@aliviohospital.com",
                password: "password123"
            };

            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();
                
                if (response.ok) {
                    tokenSesion = result.token;
                    mostrarResultado('result1', 
                        `‚úÖ √âXITO: Login exitoso<br>
                         <strong>Usuario:</strong> ${datos.email}<br>
                         <strong>Token generado:</strong> ${tokenSesion ? 'S√≠' : 'No'}<br>
                         <strong>Datos del usuario:</strong><br>
                         <div class="credentials-test">${JSON.stringify(result.usuario, null, 2)}</div>`, 'success');
                    return true;
                } else {
                    mostrarResultado('result1', 
                        `‚ùå ERROR: ${result.error}<br>
                         <strong>C√≥digo:</strong> ${response.status}<br>
                         <strong>Credenciales usadas:</strong><br>
                         <div class="credentials-test">Email: ${datos.email}<br>Password: ${datos.password}</div>`, 'error');
                    return false;
                }
            } catch (error) {
                mostrarResultado('result1', 
                    `‚ùå ERROR DE CONEXI√ìN: ${error.message}<br>
                     <strong>Verifique que el servidor est√© ejecut√°ndose</strong>`, 'error');
                return false;
            }
        }

        // 2. Prueba: Login con Email Incorrecto
        async function testLoginEmailIncorrecto() {
            const datos = {
                email: "usuario_inexistente@aliviohospital.com",
                password: "password123"
            };

            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    mostrarResultado('result2', 
                        `‚úÖ √âXITO: Validaci√≥n funcionando correctamente<br>
                         <strong>Error esperado:</strong> ${result.error}<br>
                         <strong>C√≥digo:</strong> ${response.status}<br>
                         <strong>Credenciales usadas:</strong><br>
                         <div class="credentials-test">Email: ${datos.email}<br>Password: ${datos.password}</div>`, 'success');
                    return true;
                } else {
                    mostrarResultado('result2', 
                        `‚ùå ERROR: Se esperaba un error de autenticaci√≥n pero el login fue exitoso`, 'error');
                    return false;
                }
            } catch (error) {
                mostrarResultado('result2', 
                    `‚ö†Ô∏è ADVERTENCIA: ${error.message}`, 'info');
                return false;
            }
        }

        // 3. Prueba: Login con Contrase√±a Incorrecta
        async function testLoginPasswordIncorrecto() {
            const datos = {
                email: "maria.garcia@aliviohospital.com",
                password: "contrase√±a_incorrecta"
            };

            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    mostrarResultado('result3', 
                        `‚úÖ √âXITO: Validaci√≥n de contrase√±a funcionando<br>
                         <strong>Error:</strong> ${result.error}<br>
                         <strong>C√≥digo:</strong> ${response.status}<br>
                         <strong>Credenciales usadas:</strong><br>
                         <div class="credentials-test">Email: ${datos.email}<br>Password: ${datos.password}</div>`, 'success');
                    return true;
                } else {
                    mostrarResultado('result3', 
                        `‚ùå ERROR: Se esperaba un error de contrase√±a pero el login fue exitoso`, 'error');
                    return false;
                }
            } catch (error) {
                mostrarResultado('result3', 
                    `‚ö†Ô∏è ADVERTENCIA: ${error.message}`, 'info');
                return false;
            }
        }

        // 4. Prueba: Login sin Credenciales
        async function testLoginSinCredenciales() {
            const datos = {
                email: "",
                password: ""
            };

            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    mostrarResultado('result4', 
                        `‚úÖ √âXITO: Validaci√≥n de campos vac√≠os funcionando<br>
                         <strong>Error:</strong> ${result.error}<br>
                         <strong>C√≥digo:</strong> ${response.status}`, 'success');
                    return true;
                } else {
                    mostrarResultado('result4', 
                        `‚ùå ERROR: Se permiti√≥ login sin credenciales`, 'error');
                    return false;
                }
            } catch (error) {
                mostrarResultado('result4', 
                    `‚ö†Ô∏è ADVERTENCIA: ${error.message}`, 'info');
                return false;
            }
        }

        // 5. Prueba: Login con Email Inv√°lido
        async function testLoginEmailInvalido() {
            const datos = {
                email: "email_invalido",
                password: "password123"
            };

            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    mostrarResultado('result5', 
                        `‚úÖ √âXITO: Validaci√≥n de formato de email funcionando<br>
                         <strong>Error:</strong> ${result.error}<br>
                         <strong>C√≥digo:</strong> ${response.status}<br>
                         <strong>Email usado:</strong> ${datos.email}`, 'success');
                    return true;
                } else {
                    mostrarResultado('result5', 
                        `‚ùå ERROR: Se acept√≥ email con formato inv√°lido`, 'error');
                    return false;
                }
            } catch (error) {
                mostrarResultado('result5', 
                    `‚ö†Ô∏è ADVERTENCIA: ${error.message}`, 'info');
                return false;
            }
        }

        // 6. Prueba: Validaci√≥n de Campos (simulaci√≥n frontend)
        function testValidacionCampos() {
            // Simulamos la validaci√≥n del formulario
            const campos = {
                email: "",
                password: ""
            };
            
            let errores = [];
            
            if (!campos.email) errores.push("Email es requerido");
            if (!campos.password) errores.push("Contrase√±a es requerida");
            
            if (errores.length > 0) {
                mostrarResultado('result6', 
                    `‚úÖ √âXITO: Validaci√≥n funcionando correctamente<br>
                     <strong>Errores detectados:</strong><br>
                     - ${errores.join('<br>- ')}`, 'success');
                return true;
            } else {
                mostrarResultado('result6', 
                    `‚ùå ERROR: Se esperaba detectar errores de validaci√≥n`, 'error');
                return false;
            }
        }

        // 7. Prueba: Mostrar/Ocultar Contrase√±a
        function testTogglePassword() {
            // Simulamos la funcionalidad de mostrar/ocultar contrase√±a
            let passwordVisible = false;
            const tipoInicial = "password";
            const tipoAlternativo = "text";
            
            // Simular toggle
            passwordVisible = !passwordVisible;
            const tipoActual = passwordVisible ? tipoAlternativo : tipoInicial;
            
            if (tipoActual === tipoAlternativo && passwordVisible) {
                mostrarResultado('result7', 
                    `‚úÖ √âXITO: Funci√≥n mostrar contrase√±a funcionando<br>
                     <strong>Estado:</strong> Contrase√±a visible<br>
                     <strong>Tipo de input:</strong> ${tipoActual}`, 'success');
                return true;
            } else {
                mostrarResultado('result7', 
                    `‚ùå ERROR: Problema en toggle de contrase√±a`, 'error');
                return false;
            }
        }

        // 8. Prueba: Limpiar Formulario
        function testLimpiarFormulario() {
            // Simulamos el limpiado de formulario
            const campos = {
                email: "usuario@ejemplo.com",
                password: "contrase√±a123",
                rememberMe: true
            };
            
            // Limpiar formulario
            Object.keys(campos).forEach(key => {
                if (typeof campos[key] === 'boolean') {
                    campos[key] = false;
                } else {
                    campos[key] = "";
                }
            });
            
            const todosVacios = Object.values(campos).every(valor => 
                typeof valor === 'boolean' ? valor === false : valor === ""
            );
            
            if (todosVacios) {
                mostrarResultado('result8', 
                    `‚úÖ √âXITO: Formulario limpiado correctamente<br>
                     <strong>Estado:</strong> Todos los campos est√°n vac√≠os/desmarcados`, 'success');
                return true;
            } else {
                mostrarResultado('result8', 
                    `‚ùå ERROR: El formulario no se limpi√≥ completamente`, 'error');
                return false;
            }
        }

        // 9. Prueba: Token de Autenticaci√≥n
        async function testTokenAutenticacion() {
            if (!tokenSesion) {
                // Primero hacemos login para obtener token
                const datos = {
                    email: "maria.garcia@aliviohospital.com",
                    password: "password123"
                };

                try {
                    const response = await fetch('http://localhost:5000/api/auth/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(datos)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        tokenSesion = result.token;
                    }
                } catch (error) {
                    mostrarResultado('result9', 
                        `‚ùå ERROR: No se pudo obtener token - ${error.message}`, 'error');
                    return false;
                }
            }

            // Verificar token
            try {
                const response = await fetch('http://localhost:5000/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${tokenSesion}`
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    mostrarResultado('result9', 
                        `‚úÖ √âXITO: Token v√°lido y funcionando<br>
                         <strong>Token:</strong> ${tokenSesion.substring(0, 20)}...<br>
                         <strong>Usuario verificado:</strong> ${result.usuario.email}`, 'success');
                    return true;
                } else {
                    mostrarResultado('result9', 
                        `‚ùå ERROR: Token inv√°lido - ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                mostrarResultado('result9', 
                    `‚ùå ERROR: ${error.message}`, 'error');
                return false;
            }
        }

        // 10. Prueba: Expiraci√≥n de Sesi√≥n (simulaci√≥n)
        function testExpiracionSesion() {
            // Simulamos expiraci√≥n de sesi√≥n
            const tiempoCreacion = new Date();
            const tiempoExpiracion = new Date(tiempoCreacion.getTime() + (60 * 60 * 1000)); // 1 hora
            const tiempoActual = new Date();
            
            const sesionExpirada = tiempoActual > tiempoExpiracion;
            
            if (!sesionExpirada) {
                mostrarResultado('result10', 
                    `‚úÖ √âXITO: Manejo de sesi√≥n funcionando<br>
                     <strong>Estado:</strong> Sesi√≥n activa<br>
                     <strong>Tiempo restante:</strong> ${Math.round((tiempoExpiracion - tiempoActual) / 1000 / 60)} minutos`, 'success');
                return true;
            } else {
                mostrarResultado('result10', 
                    `‚ö†Ô∏è ADVERTENCIA: Sesi√≥n expirada - Se requiere reautenticaci√≥n`, 'info');
                return false;
            }
        }

        // 11. Prueba: Intentos Fallidos
        async function testIntentosFallidos() {
            const intentosMaximos = 3;
            let intentos = 0;
            let bloqueado = false;
            
            // Simular m√∫ltiples intentos fallidos
            for (let i = 0; i < intentosMaximos + 1; i++) {
                intentos++;
                
                if (intentos > intentosMaximos) {
                    bloqueado = true;
                    break;
                }
                
                // Peque√±a pausa entre intentos
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (bloqueado) {
                mostrarResultado('result11', 
                    `‚úÖ √âXITO: Protecci√≥n por intentos fallidos funcionando<br>
                     <strong>Intentos:</strong> ${intentos}<br>
                     <strong>L√≠mite:</strong> ${intentosMaximos}<br>
                     <strong>Estado:</strong> Cuenta temporalmente bloqueada`, 'success');
                return true;
            } else {
                mostrarResultado('result11', 
                    `‚ùå ERROR: No se activ√≥ la protecci√≥n por intentos fallidos`, 'error');
                return false;
            }
        }

        // 12. Prueba: Redirecci√≥n Post-Login (simulaci√≥n)
        function testRedireccionPostLogin() {
            // Simulamos redirecci√≥n despu√©s de login exitoso
            const usuario = {
                email: "maria.garcia@aliviohospital.com",
                rol: "enfermero",
                nombre: "Mar√≠a Garc√≠a"
            };
            
            let rutaRedireccion = "";
            
            switch(usuario.rol) {
                case "enfermero":
                    rutaRedireccion = "/dashboard-enfermero.html";
                    break;
                case "administrador":
                    rutaRedireccion = "/dashboard-admin.html";
                    break;
                case "jefe_enfermeria":
                    rutaRedireccion = "/dashboard-jefe.html";
                    break;
                default:
                    rutaRedireccion = "/dashboard.html";
            }
            
            if (rutaRedireccion === "/dashboard-enfermero.html") {
                mostrarResultado('result12', 
                    `‚úÖ √âXITO: Redirecci√≥n configurada correctamente<br>
                     <strong>Usuario:</strong> ${usuario.nombre}<br>
                     <strong>Rol:</strong> ${usuario.rol}<br>
                     <strong>Redirecci√≥n a:</strong> ${rutaRedireccion}`, 'success');
                return true;
            } else {
                mostrarResultado('result12', 
                    `‚ùå ERROR: Problema en redirecci√≥n post-login`, 'error');
                return false;
            }
        }

        // 13. Prueba: Diferentes Roles de Usuario
        async function testDiferentesRoles() {
            const usuariosTest = [
                { email: "enfermero@aliviohospital.com", rol: "enfermero" },
                { email: "admin@aliviohospital.com", rol: "administrador" },
                { email: "jefe@aliviohospital.com", rol: "jefe_enfermeria" }
            ];
            
            let exitosos = 0;
            
            try {
                for (const usuario of usuariosTest) {
                    // Nota: En un entorno real, necesitar√≠amos contrase√±as v√°lidas
                    const datos = {
                        email: usuario.email,
                        password: "password123" // Contrase√±a gen√©rica para prueba
                    };
                    
                    const response = await fetch('http://localhost:5000/api/auth/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(datos)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.usuario && result.usuario.rol === usuario.rol) {
                            exitosos++;
                        }
                    }
                }
                
                if (exitosos > 0) {
                    mostrarResultado('result13', 
                        `‚úÖ √âXITO: Login con diferentes roles probado<br>
                         <strong>Roles probados:</strong> ${usuariosTest.map(u => u.rol).join(', ')}<br>
                         <strong>Exitosos:</strong> ${exitosos} de ${usuariosTest.length}`, 'success');
                    return true;
                } else {
                    mostrarResultado('result13', 
                        `‚ö†Ô∏è ADVERTENCIA: No se pudieron probar todos los roles`, 'info');
                    return false;
                }
                
            } catch (error) {
                mostrarResultado('result13', 
                    `‚ùå ERROR: ${error.message}`, 'error');
                return false;
            }
        }

        // 14. Prueba: Flujo Completo
        async function testFlujoCompleto() {
            mostrarResultado('result14', 'üîÑ Ejecutando flujo completo de autenticaci√≥n...', 'info');
            
            try {
                // Paso 1: Login
                const datosLogin = {
                    email: "maria.garcia@aliviohospital.com",
                    password: "password123"
                };

                const response1 = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(datosLogin)
                });
                
                if (!response1.ok) {
                    throw new Error('Error en login');
                }
                
                const result1 = await response1.json();
                const token = result1.token;
                
                // Paso 2: Verificar token
                const response2 = await fetch('http://localhost:5000/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response2.ok) {
                    throw new Error('Error en verificaci√≥n de token');
                }
                
                // Paso 3: Obtener perfil de usuario
                const response3 = await fetch('http://localhost:5000/api/auth/perfil', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response3.ok) {
                    throw new Error('Error al obtener perfil');
                }
                
                const result3 = await response3.json();
                
                mostrarResultado('result14', 
                    `‚úÖ √âXITO: Flujo completo ejecutado correctamente<br>
                     <strong>Paso 1:</strong> Login exitoso<br>
                     <strong>Paso 2:</strong> Token verificado<br>
                     <strong>Paso 3:</strong> Perfil obtenido<br>
                     <strong>Usuario:</strong> ${result3.usuario.nombre}<br>
                     <strong>Rol:</strong> ${result3.usuario.rol}`, 'success');
                return true;
                
            } catch (error) {
                mostrarResultado('result14', 
                    `‚ùå ERROR en flujo completo: ${error.message}`, 'error');
                return false;
            }
        }

        // Funci√≥n para ejecutar todas las pruebas
        async function ejecutarTodasLasPruebas() {
            const pruebas = [
                testLoginValido,
                testLoginEmailIncorrecto,
                testLoginPasswordIncorrecto,
                testLoginSinCredenciales,
                testLoginEmailInvalido,
                testValidacionCampos,
                testTogglePassword,
                testLimpiarFormulario,
                testTokenAutenticacion,
                testExpiracionSesion,
                testIntentosFallidos,
                testRedireccionPostLogin,
                testDiferentesRoles,
                testFlujoCompleto
            ];
            
            let exitosas = 0;
            resultadosPruebas = [];
            
            mostrarResultado('resultGeneral', 'üîÑ Ejecutando todas las pruebas...', 'info');
            
            for (let i = 0; i < pruebas.length; i++) {
                const resultado = await pruebas[i]();
                resultadosPruebas.push({
                    nombre: `Prueba ${i + 1}`,
                    exitosa: resultado
                });
                
                if (resultado) exitosas++;
                
                // Peque√±a pausa entre pruebas
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const porcentaje = Math.round((exitosas / pruebas.length) * 100);
            const mensajeFinal = `
                <h4>üìä Resumen de Pruebas</h4>
                <strong>Total de pruebas:</strong> ${pruebas.length}<br>
                <strong>Exitosas:</strong> ${exitosas}<br>
                <strong>Fallidas:</strong> ${pruebas.length - exitosas}<br>
                <strong>Porcentaje de √©xito:</strong> ${porcentaje}%<br><br>
                <strong>Estado:</strong> ${porcentaje >= 80 ? '‚úÖ SATISFACTORIO' : porcentaje >= 60 ? '‚ö†Ô∏è ACEPTABLE' : '‚ùå REQUIERE ATENCI√ìN'}
            `;
            
            mostrarResultado('resultGeneral', mensajeFinal, 
                porcentaje >= 80 ? 'success' : porcentaje >= 60 ? 'info' : 'error');
        }
    </script>
</body>
</html>